# κ·Έλλ””μ–ΈνΈ μ²΄ν¬ν¬μΈν… #

μΌλ¶€ λ€ν• λ¨λΈμ€ λ°°μΉ ν¬κΈ°λ¥Ό 1λ΅ μ„¤μ •ν•κ³  κ·Έλλ””μ–ΈνΈ λ„μ (gradient accumulation)μ„ μ‚¬μ©ν•λ”λΌλ„ μ—¬μ „ν λ©”λ¨λ¦¬ λ¬Έμ λ¥Ό κ²μ„ μ μλ‹¤. μ΄λ” ν›λ ¨ κ³Όμ •μ—μ„ λ©”λ¨λ¦¬λ¥Ό μ†λΉ„ν•λ” λ‹¤μ–‘ν• μ”μ†λ“¤μ΄ μ΅΄μ¬ν•κΈ° λ•λ¬Έμ΄λ‹¤. 

μμ „ν(forward pass) κ³Όμ •μ—μ„ λ¨λ“  ν™μ„±ν™” κ°’(activation)μ„ μ €μ¥ν• ν›„, μ—­μ „ν(backward pass) μ‹ μ΄λ¥Ό ν™μ©ν•μ—¬ κ·Έλλ””μ–ΈνΈλ¥Ό κ³„μ‚°ν•λ” λ°©μ‹μ€ ν° λ©”λ¨λ¦¬ μ¤λ²„ν—¤λ“λ¥Ό μ΄λν•  μ μλ‹¤. λ°λ€λ΅, ν™μ„±ν™” κ°’μ„ μ €μ¥ν•μ§€ μ•κ³  ν•„μ”ν•  λ•λ§λ‹¤ λ‹¤μ‹ κ³„μ‚°ν•λ” λ°©μ‹μ€ κ³„μ‚°λ‰μ΄ κΈ‰μ¦ν•μ—¬ ν›λ ¨ μ†λ„κ°€ ν„μ €ν λλ ¤μ§€λ” λ¬Έμ κ°€ λ°μƒν•  μ μλ‹¤. λ‹¤μ‹ λ§ν•΄, κ·Έλλ””μ–ΈνΈ μ²΄ν¬ν¬μΈνΈλ” λ©”λ¨λ¦¬ ν¨μ¨μ„±μ„ ν–¥μƒμ‹ν‚¬ μ μμ§€λ§, ν›λ ¨ μ†λ„λ¥Ό μ•½ 20% μ •λ„ λλ¦¬κ² λ§λ“ λ‹¤. 

κ·Έλλ””μ–ΈνΈ μ²΄ν¬ν¬μΈνΈ(Gradient Checkpointing)λ” μ΄λ¬ν• λ‘ κ°€μ§€ μ ‘κ·Ό λ°©μ‹ μ‚¬μ΄μ—μ„ κ· ν•μ„ λ§μ¶”λ” μµμ ν™” κΈ°λ²•μ΄λ‹¤. 

β… κ³„μ‚° κ·Έλν”„ λ‚΄μ—μ„ **μ „λµμ μΌλ΅ μ„ νƒλ ν™μ„±ν™” κ°’λ§ μ €μ¥**ν•μ—¬ λ©”λ¨λ¦¬ μ‚¬μ©λ‰μ„ μ¤„μ΄κ³ ,  
β… ν•„μ”ν• κ²½μ° μΌλ¶€ ν™μ„±ν™” κ°’λ§ λ‹¤μ‹ κ³„μ‚°ν•μ—¬ **ν›λ ¨ μ†λ„λ¥Ό μµμ ν™”**ν•©λ‹λ‹¤.  

κ·Έλλ””μ–ΈνΈ μ²΄ν¬ν¬μΈνΈμ— λ€ν• μμ„Έν• μ„¤λ…μ€ [μ΄ λ―Έλ””μ—„ λΈ”λ΅κ·Έλ¥Ό](https://medium.com/tensorflow/fitting-larger-networks-into-memory-583e3c758ff9) μ°Έκ³ ν•λΌ.   

[Trainerμ—μ„](https://huggingface.co/docs/transformers/v4.48.2/en/main_classes/trainer#transformers.Trainer) κ·Έλλ””μ–ΈνΈ μ²΄ν¬ν¬μΈνΈλ¥Ό ν™μ„±ν™”ν•λ ¤λ©΄, [`TrainingArguments`μ—](https://huggingface.co/docs/transformers/v4.48.2/en/main_classes/trainer#transformers.TrainingArguments) ν•΄λ‹Ή ν”λκ·Έλ¥Ό μ „λ‹¬ν•λ©΄ λλ‹¤. 

```
training_args = TrainingArguments(
    per_device_train_batch_size=1, // κ° GPU(λλ” CPU)μ—μ„ ν• λ²μ— μ²λ¦¬ν•λ” λ°°μΉ ν¬κΈ°λ¥Ό 1λ΅ μ„¤μ •
    gradient_accumulation_steps=4, // Gradient Accumulation Step μλ¥Ό 4λ΅ μ„¤μ •. 4κ°μ λ―Έλ‹λ°°μΉλ¥Ό μ²λ¦¬ν• ν›„μ— ν• λ²μ μµμ ν™”(Optimizer Step)λ¥Ό μν–‰
    gradient_checkpointing=True,
    **default_args
)
```

π”Ή per_device_train_batch_size=1
   - κ° GPU(λλ” CPU)μ—μ„ ν• λ²μ— μ²λ¦¬ν•λ” λ°°μΉ ν¬κΈ°λ¥Ό 1λ΅ μ„¤μ •
   - μΌλ°μ μΌλ΅ λ€ν• λ¨λΈμ—μ„ GPU λ©”λ¨λ¦¬ λ¶€μ΅±μ„ λ°©μ§€ν•κΈ° μ„ν•΄ μ‘μ€ λ°°μΉ ν¬κΈ°λ¥Ό μ‚¬μ©
   - ν•μ§€λ§ λ„λ¬΄ μ‘μ€ λ°°μΉ ν¬κΈ°λ” λ¨λΈμ μλ ΄ μ†λ„λ¥Ό λλ¦¬κ² ν•  μλ„ μμ β†’ gradient_accumulation_stepsμ™€ ν•¨κ» μ‚¬μ©ν•μ—¬ ν¨κ³Όμ μΈ λ°°μΉ ν¬κΈ° μ¦κ°€

  π”Ή gradient_accumulation_steps=4
    - κ·Έλλ””μ–ΈνΈ λ„μ (Gradient Accumulation) μ¤ν… μλ¥Ό 4λ΅ μ„¤μ •, 
    - μ¦‰, 4κ°μ λ―Έλ‹λ°°μΉλ¥Ό μ²λ¦¬ν• ν›„μ— ν• λ²μ μµμ ν™”(Optimizer Step)λ¥Ό μν–‰
    - GPU λ©”λ¨λ¦¬κ°€ λ¶€μ΅±ν•  λ• μ μ©
      β†’ per_device_train_batch_size=1μ΄μ§€λ§, λ‚΄λ¶€μ μΌλ΅ 4κ°μ μƒν”μ„ μ²λ¦¬ν• ν›„ κ°€μ¤‘μΉ μ—…λ°μ΄νΈ
      β†’ κ²°κ³Όμ μΌλ΅ ν¨κ³Όμ μΈ λ°°μΉ ν¬κΈ°(effective batch size) = 4λ΅ μ¦κ°€
    - λ‹¨μ : μ¶”κ°€μ μΈ μμ „ν & μ—­μ „ν μ—°μ‚°μ΄ ν•„μ”ν•μ—¬ ν›λ ¨ μ†λ„κ°€ λ‹¤μ† λλ ¤μ§ μ μμ

π”Ή gradient_checkpointing=True
    - λ©”λ¨λ¦¬ μ‚¬μ©λ‰μ„ μ¤„μ΄κΈ° μ„ν• κ·Έλλ””μ–ΈνΈ μ²΄ν¬ν¬μΈνΈ κΈ°λ¥ ν™μ„±ν™”
    - μμ „ν(forward pass) μ‹ μΌλ¶€ ν™μ„±ν™” κ°’(activations)μ„ μ €μ¥ν•μ§€ μ•κ³  ν•„μ”ν•  λ• λ‹¤μ‹ κ³„μ‚°
    - μ¥μ : λ©”λ¨λ¦¬ μ‚¬μ©λ‰ μ κ° (νΉν λ€ν• λ¨λΈμ—μ„ ν¨κ³Όμ )
    - λ‹¨μ : κ³„μ‚°λ‰ μ¦κ°€ β†’ μΌλ¶€ ν™μ„±ν™” κ°’μ„ λ‹¤μ‹ κ³„μ‚°ν•΄μ•Ό ν•λ―€λ΅ ν›λ ¨ μ†λ„κ°€ λλ ¤μ§ μ μμ
    - μ΄κ±°λ€ λ¨λΈμ„ GPUμ—μ„ ν¨μ¨μ μΌλ΅ ν•™μµν•  λ• ν•„μμ μΈ κΈ°λ²•

  π”Ή **default_args
    - default_argsλ” λ‹¤λ¥Έ κΈ°λ³Έ ν›λ ¨ μ„¤μ •μ„ ν¬ν•¨ν•λ” λ”•μ…”λ„λ¦¬λ΅ μ¶”μ •λ¨
    - μλ¥Ό λ“¤λ©΄, ν•™μµλ¥ (learning_rate), μ²΄ν¬ν¬μΈνΈ μ €μ¥ κ²½λ΅(output_dir), ν›λ ¨ μ—ν¬ν¬ μ(num_train_epochs) λ“±μ΄ ν¬ν•¨λ  μ μμ
    - κΈ°μ΅΄ μ„¤μ •μ„ μ μ§€ν•λ©΄μ„ μ„μ νλΌλ―Έν„°λ“¤λ§ μ¶”κ°€λ΅ μ§€μ •ν•λ” μ—­ν• 

### κ²°λ΅  ###
 β… GPU λ©”λ¨λ¦¬κ°€ λ¶€μ΅±ν• ν™κ²½μ—μ„λ„ λ€ν• λ¨λΈμ„ ν¨κ³Όμ μΌλ΅ ν›λ ¨ν•  μ μλ„λ΅ κµ¬μ„±
 β… λ°°μΉ ν¬κΈ°λ¥Ό 1λ΅ λ‚®μ¶”κ³  κ·Έλλ””μ–ΈνΈ λ„μ μΌλ΅ ν¨κ³Όμ μΈ λ°°μΉ ν¬κΈ° μ¦κ°€
 β… κ·Έλλ””μ–ΈνΈ μ²΄ν¬ν¬μΈνΈλ¥Ό ν™μ©ν•μ—¬ λ©”λ¨λ¦¬ μ‚¬μ©λ‰ μ κ°
 β… μ¶”κ°€μ μΈ κ³„μ‚° μ¤λ²„ν—¤λ“λ” μμ§€λ§, λ©”λ¨λ¦¬ λ¶€μ΅± λ¬Έμ λ¥Ό ν•΄κ²°ν•λ©΄μ„ μ•μ •μ μΌλ΅ ν›λ ¨ κ°€λ¥

 π€ μ¦‰, μ΄ μ„¤μ •μ€ "λ©”λ¨λ¦¬κ°€ λ¶€μ΅±ν• ν™κ²½μ—μ„ μ΄κ±°λ€ λ¨λΈμ„ μ•μ •μ μΌλ΅ ν›λ ¨ν•λ” μµμ ν™”λ λ°©λ²•"μ΄λ‹¤.  

### λ‹¤λ¥Έ λ€μ• ###

κ·Έλ ‡μ§€ μ•μΌλ©΄, ν—κΉ…νμ΄μ¤μ Accelerateλ¥Ό μ‚¬μ©ν•  μλ„ μμµλ‹λ‹¤. ν—κΉ…νμ΄μ¤ Accelerateλ¥Ό ν™μ©ν• μμ λ” μ—¬κΈ°λ¥Ό μ°Έκ³ ν•λΌ.





